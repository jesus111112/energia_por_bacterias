<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celda de Combustible Microbiana 3D (Versi√≥n Vanilla JS)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Estilos CSS puros para la interfaz */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #1e3a8a; /* Azul oscuro */
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        .info-panel, .legend-panel, .reactions-panel {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.75); /* bg-black bg-opacity-75 */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 10; /* Asegura que la interfaz est√© sobre el 3D */
        }

        /* Panel de control */
        .info-panel {
            top: 1rem;
            left: 1rem;
            max-width: 20rem;
        }
        .info-panel h2 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #f6e05e; /* text-yellow-400 */
        }
        .voltage-display {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background-color: rgba(26, 37, 24, 0.5); /* bg-green-900 bg-opacity-50 */
            border-radius: 0.25rem;
        }
        .voltage-display .label {
            font-size: 0.875rem;
            font-weight: 600;
        }
        .voltage-display .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #68d391; /* text-green-400 */
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .button-group button {
            width: 100%;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #toggleLabels { background-color: #2b6cb0; }
        #toggleLabels:hover { background-color: #2c5282; }
        #toggleRotation { background-color: #805ad5; }
        #toggleRotation:hover { background-color: #6b46c1; }

        /* Panel de leyenda */
        .legend-panel {
            top: 1rem;
            right: 1rem;
            max-width: 20rem;
        }
        .legend-panel h3 {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: #f6e05e;
        }
        .legend-panel .item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .legend-panel .section {
            padding-left: 0.5rem;
            border-left-width: 4px;
            margin-top: 0.5rem;
        }
        .legend-panel .anode { border-left-color: #f6e05e; }
        .legend-panel .membrane { border-left-color: #48bb78; }
        .legend-panel .cathode { border-left-color: #4299e1; }
        .legend-panel .circuit { border-left-color: #f56565; } /* naranja */
        .legend-panel .products { border-left-color: #a0aec0; }
        .legend-panel .bold { font-weight: bold; }
        .legend-panel .italic { color: #a0aec0; font-style: italic; }
        .legend-panel .color-red { color: #f56565; }
        .legend-panel .color-green { color: #68d391; }
        .legend-panel .color-blue { color: #4299e1; }
        .legend-panel .color-yellow { color: #f6e05e; }

        /* Panel de reacciones */
        .reactions-panel {
            bottom: 1rem;
            left: 1rem;
            max-width: 28rem;
        }
        .reactions-panel h3 {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #f6e05e;
        }
        .reactions-panel .reaction {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .reactions-panel .anode-rxn { background-color: rgba(146, 64, 14, 0.5); }
        .reactions-panel .cathode-rxn { background-color: rgba(26, 32, 44, 0.5); }
    </style>
</head>
<body>
    <link rel="stylesheet" href="global.css">
    <script src="drag-button.js" defer></script>

    <button class="return-button" onclick="window.location.href='index.html'">
    Regresar
    </button>
    
    <div id="canvas-container"></div>
    
    <div class="info-panel">
        <h2 id="title">‚ö° Celda de Combustible Microbiana</h2>
        
        <div class="voltage-display">
            <div class="label">Voltaje generado:</div>
            <div class="value" id="voltage-output">0.00 V</div>
        </div>

        <div class="button-group">
            <button id="toggleLabels" onclick="toggleLabels()">Ocultar etiquetas</button>
            <button id="toggleRotation" onclick="toggleRotation()">Detener rotaci√≥n</button>
        </div>
    </div>

    <div class="legend-panel" id="legend-panel">
        <h3>üìã Componentes y Materiales</h3>
        
        <div class="item">
            <div class="section anode">
                <div class="bold">üü° C√ÅMARA AN√ìDICA (izquierda)</div>
                <div>‚Ä¢ Electrodo: Grafito/Carb√≥n activado</div>
                <div>‚Ä¢ Medio: Materia org√°nica (glucosa, acetato)</div>
                <div>‚Ä¢ <span class="color-red">üî¥</span><span class="color-green">üü¢</span><span class="color-blue">üîµ</span> Bacterias electrog√©nicas</div>
                <div class="italic"> (Geobacter, Shewanella, Pseudomonas)</div>
                <div>‚Ä¢ Ambiente: Anaer√≥bico (sin O‚ÇÇ)</div>
            </div>

            <div class="section membrane">
                <div class="bold">üü¢ MEMBRANA CENTRAL</div>
                <div>‚Ä¢ Material: Nafion o Ultrex</div>
                <div>‚Ä¢ Funci√≥n: Intercambio de protones (H‚Å∫)</div>
                <div>‚Ä¢ <span class="color-red">üî¥</span> Protones H‚Å∫ atravesando</div>
            </div>

            <div class="section cathode">
                <div class="bold">üîµ C√ÅMARA CAT√ìDICA (derecha)</div>
                <div>‚Ä¢ Electrodo: Acero inoxidable/Carb√≥n</div>
                <div>‚Ä¢ Catalizador: Platino, MnO‚ÇÇ o Fe‚ÇÇO‚ÇÉ</div>
                <div>‚Ä¢ Medio: Soluci√≥n con O‚ÇÇ disuelto</div>
                <div>‚Ä¢ Ambiente: Aer√≥bico (con ox√≠geno)</div>
            </div>

            <div class="section circuit">
                <div class="bold">üü† CIRCUITO EXTERNO</div>
                <div>‚Ä¢ Cable conductor de cobre</div>
                <div>‚Ä¢ <span class="color-yellow">‚ö°</span> Electrones (e‚Åª) fluyendo</div>
                <div>‚Ä¢ üîã Fuente externa (>0.2V)</div>
            </div>

            <div class="section products">
                <div class="bold">üå´Ô∏è PRODUCTOS</div>
                <div>‚Ä¢ ‚ö´ CO‚ÇÇ (del √°nodo)</div>
                <div>‚Ä¢ ‚ö™ H‚ÇÇ gas hidr√≥geno (del c√°todo)</div>
            </div>
        </div>
    </div>

    <div class="reactions-panel" id="reactions-panel">
        <h3>‚öóÔ∏è Reacciones</h3>
        <div class="reaction anode-rxn">
            <div class="bold">√Ånodo (oxidaci√≥n):</div>
            <div>CH‚ÇÉCOOH + 2H‚ÇÇO ‚Üí 2CO‚ÇÇ + 8H‚Å∫ + 8e‚Åª</div>
        </div>
        <div class="reaction cathode-rxn">
            <div class="bold">C√°todo (reducci√≥n):</div>
            <div>2H‚Å∫ + 2e‚Åª ‚Üí H‚ÇÇ</div>
        </div>
    </div>

    <script>
        let mountRef = document.getElementById('canvas-container');
        let voltage = 0.3;
        let showLabels = true;
        let rotation = true;
        
        // Variables globales de Three.js
        let scene, camera, renderer, cableCurve;
        let bacteria = [];
        let protons = [];
        let electrons = [];
        let co2Molecules = [];
        let h2Molecules = [];
        let time = 0;

        // --- Funciones de control de UI ---
        
        function toggleLabels() {
            showLabels = !showLabels;
            const legend = document.getElementById('legend-panel');
            const reactions = document.getElementById('reactions-panel');
            const button = document.getElementById('toggleLabels');

            legend.style.display = showLabels ? 'block' : 'none';
            reactions.style.display = showLabels ? 'block' : 'none';
            button.textContent = showLabels ? 'Ocultar etiquetas' : 'Mostrar etiquetas';
        }

        function toggleRotation() {
            rotation = !rotation;
            const button = document.getElementById('toggleRotation');
            button.textContent = rotation ? 'Detener rotaci√≥n' : 'Activar rotaci√≥n';
        }

        function updateVoltage(newVoltage) {
            voltage = newVoltage;
            document.getElementById('voltage-output').textContent = voltage.toFixed(2) + ' V';
        }

        // --- Configuraci√≥n de Three.js ---

        function init() {
            if (!mountRef) return;

            // Configuraci√≥n de la escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e3a8a);

            camera = new THREE.PerspectiveCamera(
                60,
                mountRef.clientWidth / mountRef.clientHeight,
                0.1,
                1000
            );
            camera.position.set(8, 6, 12);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(mountRef.clientWidth, mountRef.clientHeight);
            renderer.shadowMap.enabled = true;
            mountRef.appendChild(renderer.domElement);

            // Iluminaci√≥n
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xffaa00, 0.5);
            pointLight.position.set(0, 5, 0);
            scene.add(pointLight);

            // C√ÅMARA AN√ìDICA (izquierda - amarillo verdoso)
            const anodeGeometry = new THREE.BoxGeometry(3, 4, 3);
            const anodeMaterial = new THREE.MeshPhongMaterial({
                color: 0xd4e157,
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            const anodeChamber = new THREE.Mesh(anodeGeometry, anodeMaterial);
            anodeChamber.position.set(-2.5, 0, 0);
            scene.add(anodeChamber);

            // L√≠quido en el √°nodo (materia org√°nica)
            const liquidGeometry = new THREE.BoxGeometry(2.8, 3, 2.8);
            const liquidMaterial = new THREE.MeshPhongMaterial({
                color: 0x8b7355,
                transparent: true,
                opacity: 0.6
            });
            const organicMatter = new THREE.Mesh(liquidGeometry, liquidMaterial);
            organicMatter.position.set(-2.5, -0.5, 0);
            scene.add(organicMatter);

            // Electrodo √Ånodo (grafito)
            const anodeElectrodeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 3.5, 16);
            const anodeElectrodeMaterial = new THREE.MeshPhongMaterial({ color: 0x2c2c2c });
            const anodeElectrode = new THREE.Mesh(anodeElectrodeGeometry, anodeElectrodeMaterial);
            anodeElectrode.position.set(-2.5, 0, 0);
            scene.add(anodeElectrode);

            // Bacterias (esferas peque√±as)
            const bacteriaColors = [0xff1744, 0x00e676, 0x2979ff, 0xff9100];
            for (let i = 0; i < 30; i++) {
                const bacteriaGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const bacteriaMaterial = new THREE.MeshPhongMaterial({
                    color: bacteriaColors[Math.floor(Math.random() * bacteriaColors.length)],
                    emissive: bacteriaColors[Math.floor(Math.random() * bacteriaColors.length)],
                    emissiveIntensity: 0.3
                });
                const bacterium = new THREE.Mesh(bacteriaGeometry, bacteriaMaterial);
                bacterium.position.set(
                    -2.5 + (Math.random() - 0.5) * 2.5,
                    (Math.random() - 0.5) * 3,
                    (Math.random() - 0.5) * 2.5
                );
                bacteria.push(bacterium);
                scene.add(bacterium);
            }

            // MEMBRANA DE INTERCAMBIO PROT√ìNICO
            const membraneGeometry = new THREE.BoxGeometry(0.15, 4, 3);
            const membraneMaterial = new THREE.MeshPhongMaterial({
                color: 0x00a86b,
                transparent: true,
                opacity: 0.7
            });
            const membrane = new THREE.Mesh(membraneGeometry, membraneMaterial);
            membrane.position.set(0, 0, 0);
            scene.add(membrane);

            // Protones atravesando la membrana
            for (let i = 0; i < 15; i++) {
                const protonGeometry = new THREE.SphereGeometry(0.08, 8, 8);
                const protonMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff6b6b,
                    emissive: 0xff0000,
                    emissiveIntensity: 0.5
                });
                const proton = new THREE.Mesh(protonGeometry, protonMaterial);
                proton.position.set(
                    -1 + Math.random() * 2,
                    (Math.random() - 0.5) * 3.5,
                    (Math.random() - 0.5) * 2.5
                );
                proton.userData.velocity = Math.random() * 0.02 + 0.01;
                protons.push(proton);
                scene.add(proton);
            }

            // C√ÅMARA CAT√ìDICA (derecha - verde claro)
            const cathodeGeometry = new THREE.BoxGeometry(3, 4, 3);
            const cathodeMaterial = new THREE.MeshPhongMaterial({
                color: 0x81c784,
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            const cathodeChamber = new THREE.Mesh(cathodeGeometry, cathodeMaterial);
            cathodeChamber.position.set(2.5, 0, 0);
            scene.add(cathodeChamber);

            // Soluci√≥n electrol√≠tica en el c√°todo
            const cathodeFluidGeometry = new THREE.BoxGeometry(2.8, 3, 2.8);
            const cathodeFluidMaterial = new THREE.MeshPhongMaterial({
                color: 0x4fc3f7,
                transparent: true,
                opacity: 0.5
            });
            const cathodeFluid = new THREE.Mesh(cathodeFluidGeometry, cathodeFluidMaterial);
            cathodeFluid.position.set(2.5, -0.5, 0);
            scene.add(cathodeFluid);

            // Electrodo C√°todo
            const cathodeElectrodeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 3.5, 16);
            const cathodeElectrodeMaterial = new THREE.MeshPhongMaterial({ color: 0x757575 });
            const cathodeElectrode = new THREE.Mesh(cathodeElectrodeGeometry, cathodeElectrodeMaterial);
            cathodeElectrode.position.set(2.5, 0, 0);
            scene.add(cathodeElectrode);

            // Mol√©culas de CO2 saliendo del √°nodo
            for (let i = 0; i < 8; i++) {
                const co2Geometry = new THREE.SphereGeometry(0.12, 8, 8);
                const co2Material = new THREE.MeshPhongMaterial({
                    color: 0x666666,
                    transparent: true,
                    opacity: 0.6
                });
                const co2 = new THREE.Mesh(co2Geometry, co2Material);
                co2.position.set(-2.5, 2 + Math.random(), (Math.random() - 0.5) * 2);
                co2.userData.velocity = Math.random() * 0.02 + 0.01;
                co2Molecules.push(co2);
                scene.add(co2);
            }

            // Fuente de energ√≠a externa (arriba del c√°todo)
            const powerSourceGeometry = new THREE.BoxGeometry(1, 0.8, 0.6);
            const powerSourceMaterial = new THREE.MeshPhongMaterial({ color: 0x1976d2 });
            const powerSource = new THREE.Mesh(powerSourceGeometry, powerSourceMaterial);
            powerSource.position.set(2.5, 3, 0);
            scene.add(powerSource);

            // Cable del circuito externo
            cableCurve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(-2.5, 2.5, 0),
                new THREE.Vector3(-2.5, 3.5, 0),
                new THREE.Vector3(0, 4, 0),
                new THREE.Vector3(2.5, 3.5, 0),
                new THREE.Vector3(2.5, 2.5, 0)
            ]);

            const cableGeometry = new THREE.TubeGeometry(cableCurve, 50, 0.08, 8, false);
            const cableMaterial = new THREE.MeshPhongMaterial({ color: 0xffa000 });
            const cable = new THREE.Mesh(cableGeometry, cableMaterial);
            scene.add(cable);

            // Electrones en el cable (peque√±as esferas naranjas)
            for (let i = 0; i < 20; i++) {
                const electronGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const electronMaterial = new THREE.MeshPhongMaterial({
                    color: 0xffd700,
                    emissive: 0xffaa00,
                    emissiveIntensity: 0.8
                });
                const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                const t = i / 20;
                const point = cableCurve.getPoint(t);
                electron.position.copy(point);
                electron.userData.t = t;
                electrons.push(electron);
                scene.add(electron);
            }

            // Mol√©culas de H2 (hidr√≥geno) saliendo del c√°todo
            for (let i = 0; i < 6; i++) {
                const h2Group = new THREE.Group();
                
                const h1Geometry = new THREE.SphereGeometry(0.15, 8, 8);
                const h1Material = new THREE.MeshPhongMaterial({ color: 0xe0e0e0 });
                const h1 = new THREE.Mesh(h1Geometry, h1Material);
                h1.position.set(-0.15, 0, 0);
                
                const h2Geometry = new THREE.SphereGeometry(0.15, 8, 8);
                const h2Material = new THREE.MeshPhongMaterial({ color: 0xe0e0e0 });
                const h2 = new THREE.Mesh(h2Geometry, h2Material);
                h2.position.set(0.15, 0, 0);
                
                h2Group.add(h1);
                h2Group.add(h2);
                // La posici√≥n es la salida del c√°todo (x=2.5) y no 4, para que se vea bien en 3D.
                h2Group.position.set(2.5, 2 + Math.random() * 2, (Math.random() - 0.5) * 2);
                h2Group.userData.velocity = Math.random() * 0.015 + 0.01;
                h2Molecules.push(h2Group);
                scene.add(h2Group);
            }

            animate();
        }

        // --- Bucle de animaci√≥n ---

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;

            // Rotar la escena completa
            if (rotation) {
                scene.rotation.y += 0.002;
            }

            // Animar bacterias
            bacteria.forEach((b, i) => {
                b.position.y += Math.sin(time * 2 + i) * 0.005;
                b.rotation.x += 0.02;
                b.rotation.y += 0.02;
            });

            // Animar protones (H+)
            protons.forEach(p => {
                p.position.x += p.userData.velocity;
                // Reiniciar del lado del √°nodo (-2.5) si cruzan el c√°todo (2.5)
                if (p.position.x > 2.5) p.position.x = -2.5; 
            });

            // Animar electrones en el cable
            electrons.forEach(e => {
                e.userData.t += 0.005;
                if (e.userData.t > 1) e.userData.t = 0;
                const point = cableCurve.getPoint(e.userData.t);
                e.position.copy(point);
            });

            // Animar CO2 (saliendo del √°nodo)
            co2Molecules.forEach(co2 => {
                co2.position.y += co2.userData.velocity;
                if (co2.position.y > 5) co2.position.y = 2; // Reaparecer
            });

            // Animar H2 (saliendo del c√°todo)
            h2Molecules.forEach(h2 => {
                h2.position.y += h2.userData.velocity;
                h2.rotation.z += 0.02;
                if (h2.position.y > 5) h2.position.y = 2; // Reaparecer
            });

            // Actualizar voltaje simulado
            const newVoltage = 0.3 + Math.sin(time * 0.5) * 0.1;
            updateVoltage(newVoltage);

            renderer.render(scene, camera);
        }

        // --- Manejo de eventos ---

        function handleResize() {
            if (!mountRef || !camera || !renderer) return;
            camera.aspect = mountRef.clientWidth / mountRef.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(mountRef.clientWidth, mountRef.clientHeight);
        }

        window.addEventListener('resize', handleResize);

        // Inicializar la simulaci√≥n al cargar la p√°gina
        window.onload = init;
    </script>

</body>

</html>

