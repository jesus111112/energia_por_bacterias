<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador 3D con Programaci√≥n por Bloques</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #1a1a2e;
            color: white;
        }
        
        /* Layout principal */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            gap: 0;
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Panel de herramientas */
        .tools-panel {
            background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .tool-btn {
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .tool-btn:hover, .tool-btn.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .tool-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .tool-name {
            font-size: 11px;
        }
        
        .color-picker-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .color-option:hover, .color-option.active {
            border-color: white;
            transform: scale(1.1);
        }
        
        .shape-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .shape-btn {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shape-btn:hover, .shape-btn.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        /* Canvas 3D */
        .canvas-area {
            position: relative;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        #canvas3d {
            width: 100%;
            height: 100%;
        }
        
        .canvas-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        
        .canvas-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        /* Panel de propiedades */
        .properties-panel {
            background: rgba(15, 23, 42, 0.95);
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
            padding: 20px;
        }
        
        .property-item {
            margin-bottom: 15px;
        }
        
        .property-label {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }
        
        .property-input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            font-size: 13px;
        }
        
        /* Panel de programaci√≥n */
        .programming-panel {
            grid-column: 1 / -1;
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
        }
        
        .blocks-palette {
            width: 250px;
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            overflow-y: auto;
        }
        
        .block-category {
            margin-bottom: 15px;
        }
        
        .category-title {
            font-size: 12px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 8px;
        }
        
        .block-item {
            padding: 10px;
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid #667eea;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: move;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .block-item:hover {
            background: rgba(102, 126, 234, 0.4);
            transform: translateX(5px);
        }
        
        .block-item.event { border-color: #f59e0b; background: rgba(245, 158, 11, 0.2); }
        .block-item.control { border-color: #10b981; background: rgba(16, 185, 129, 0.2); }
        .block-item.motion { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .block-item.looks { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.2); }
        
        .workspace {
            flex: 1;
            padding: 15px;
            overflow: auto;
            position: relative;
        }
        
        .dropped-block {
            padding: 12px;
            background: rgba(102, 126, 234, 0.3);
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dropped-block.event { border-color: #f59e0b; background: rgba(245, 158, 11, 0.3); }
        .dropped-block.control { border-color: #10b981; background: rgba(16, 185, 129, 0.3); }
        .dropped-block.motion { border-color: #3b82f6; background: rgba(59, 130, 246, 0.3); }
        .dropped-block.looks { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.3); }
        
        .block-delete {
            background: #ef4444;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .code-output {
            width: 300px;
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 15px;
            overflow-y: auto;
        }
        
        .code-title {
            font-size: 12px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 10px;
        }
        
        .code-preview {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #10b981;
            white-space: pre-wrap;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fbbf24;
        }
        
        .modal-text {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                üé® Simulador 3D + Programaci√≥n
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-secondary" onclick="importProject()">üìÇ Importar</button>
                <button class="btn btn-secondary" onclick="saveProject()">üíæ Guardar</button>
                <button class="btn btn-primary" onclick="runSimulation()">‚ñ∂Ô∏è Ejecutar</button>
            </div>
        </div>
        
        <!-- Panel de herramientas -->
        <div class="tools-panel">
            <div class="panel-section">
                <div class="section-title">üîß Herramientas</div>
                <div class="tool-grid">
                    <div class="tool-btn active" onclick="selectTool('select')" data-tool="select">
                        <div class="tool-icon">üëÜ</div>
                        <div class="tool-name">Seleccionar</div>
                    </div>
                    <div class="tool-btn" onclick="selectTool('move')" data-tool="move">
                        <div class="tool-icon">‚úã</div>
                        <div class="tool-name">Mover</div>
                    </div>
                    <div class="tool-btn" onclick="selectTool('rotate')" data-tool="rotate">
                        <div class="tool-icon">üîÑ</div>
                        <div class="tool-name">Rotar</div>
                    </div>
                    <div class="tool-btn" onclick="selectTool('scale')" data-tool="scale">
                        <div class="tool-icon">‚ÜîÔ∏è</div>
                        <div class="tool-name">Escalar</div>
                    </div>
                    <div class="tool-btn" onclick="selectTool('paint')" data-tool="paint">
                        <div class="tool-icon">üé®</div>
                        <div class="tool-name">Pintar</div>
                    </div>
                    <div class="tool-btn" onclick="selectTool('delete')" data-tool="delete">
                        <div class="tool-icon">üóëÔ∏è</div>
                        <div class="tool-name">Eliminar</div>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">üì¶ Formas 3D</div>
                <div class="shape-selector">
                    <div class="shape-btn" onclick="addShape('box')">
                        ‚óºÔ∏è Cubo
                    </div>
                    <div class="shape-btn" onclick="addShape('sphere')">
                        ‚ö™ Esfera
                    </div>
                    <div class="shape-btn" onclick="addShape('cylinder')">
                        üóúÔ∏è Cilindro
                    </div>
                    <div class="shape-btn" onclick="addShape('cone')">
                        üî∫ Cono
                    </div>
                    <div class="shape-btn" onclick="addShape('torus')">
                        üç© Toroide
                    </div>
                    <div class="shape-btn" onclick="addShape('plane')">
                        ‚ñ≠ Plano
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">üé® Colores</div>
                <div class="color-picker-container">
                    <div class="color-option active" style="background: #ef4444;" onclick="selectColor('#ef4444')"></div>
                    <div class="color-option" style="background: #f59e0b;" onclick="selectColor('#f59e0b')"></div>
                    <div class="color-option" style="background: #10b981;" onclick="selectColor('#10b981')"></div>
                    <div class="color-option" style="background: #3b82f6;" onclick="selectColor('#3b82f6')"></div>
                    <div class="color-option" style="background: #8b5cf6;" onclick="selectColor('#8b5cf6')"></div>
                    <div class="color-option" style="background: #ec4899;" onclick="selectColor('#ec4899')"></div>
                    <div class="color-option" style="background: #fbbf24;" onclick="selectColor('#fbbf24')"></div>
                    <div class="color-option" style="background: #14b8a6;" onclick="selectColor('#14b8a6')"></div>
                    <div class="color-option" style="background: #6366f1;" onclick="selectColor('#6366f1')"></div>
                    <div class="color-option" style="background: #ffffff;" onclick="selectColor('#ffffff')"></div>
                </div>
            </div>
        </div>
        
        <!-- Canvas 3D -->
        <div class="canvas-area">
            <div id="canvas3d"></div>
            <div class="canvas-controls">
                <button class="btn btn-secondary" onclick="resetCamera()">üì∑ Reset C√°mara</button>
                <button class="btn btn-secondary" onclick="toggleGrid()">‚äû Grid</button>
            </div>
            <div class="canvas-info">
                <div>üñ±Ô∏è Click: Seleccionar | Arrastrar: Rotar vista</div>
                <div id="object-count">Objetos: 0</div>
            </div>
        </div>
        
        <!-- Panel de propiedades -->
        <div class="properties-panel">
            <div class="section-title">‚öôÔ∏è Propiedades</div>
            <div id="properties-content">
                <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                    Selecciona un objeto para ver sus propiedades
                </p>
            </div>
        </div>
        
        <!-- Panel de programaci√≥n -->
        <div class="programming-panel">
            <div class="blocks-palette">
                <div class="block-category">
                    <div class="category-title">üéØ Eventos</div>
                    <div class="block-item event" draggable="true" data-block="start">
                        Al iniciar programa
                    </div>
                    <div class="block-item event" draggable="true" data-block="click">
                        Al hacer clic en objeto
                    </div>
                    <div class="block-item event" draggable="true" data-block="key">
                        Al presionar tecla [espacio]
                    </div>
                </div>
                
                <div class="block-category">
                    <div class="category-title">üéÆ Control</div>
                    <div class="block-item control" draggable="true" data-block="wait">
                        Esperar [1] segundos
                    </div>
                    <div class="block-item control" draggable="true" data-block="repeat">
                        Repetir [10] veces
                    </div>
                    <div class="block-item control" draggable="true" data-block="forever">
                        Por siempre
                    </div>
                    <div class="block-item control" draggable="true" data-block="if">
                        Si [condici√≥n] entonces
                    </div>
                </div>
                
                <div class="block-category">
                    <div class="category-title">üöÄ Movimiento</div>
                    <div class="block-item motion" draggable="true" data-block="moveX">
                        Mover X por [10]
                    </div>
                    <div class="block-item motion" draggable="true" data-block="moveY">
                        Mover Y por [10]
                    </div>
                    <div class="block-item motion" draggable="true" data-block="moveZ">
                        Mover Z por [10]
                    </div>
                    <div class="block-item motion" draggable="true" data-block="rotate">
                        Rotar [90] grados
                    </div>
                    <div class="block-item motion" draggable="true" data-block="goto">
                        Ir a X:[0] Y:[0] Z:[0]
                    </div>
                </div>
                
                <div class="block-category">
                    <div class="category-title">üëÅÔ∏è Apariencia</div>
                    <div class="block-item looks" draggable="true" data-block="color">
                        Cambiar color a [rojo]
                    </div>
                    <div class="block-item looks" draggable="true" data-block="size">
                        Cambiar tama√±o a [100]%
                    </div>
                    <div class="block-item looks" draggable="true" data-block="show">
                        Mostrar
                    </div>
                    <div class="block-item looks" draggable="true" data-block="hide">
                        Ocultar
                    </div>
                </div>
            </div>
            
            <div class="workspace" id="workspace">
                <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px;">
                    Arrastra bloques aqu√≠ para programar
                </p>
            </div>
            
            <div class="code-output">
                <div class="code-title">üíª C√≥digo Generado</div>
                <div class="code-preview" id="code-preview">// El c√≥digo aparecer√° aqu√≠...</div>
            </div>
        </div>
    </div>
    
    <!-- Modal de ejecuci√≥n -->
    <div class="modal" id="runModal">
        <div class="modal-content">
            <div class="modal-title">‚ñ∂Ô∏è Ejecutando Simulaci√≥n</div>
            <div class="modal-text" id="runStatus">
                Iniciando simulaci√≥n...
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="stopSimulation()">‚èπÔ∏è Detener</button>
                <button class="btn btn-primary" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de importar -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-title">üìÇ Importar Proyecto</div>
            <div class="modal-text">
                <p style="margin-bottom: 15px;">Selecciona un archivo de proyecto (.json) guardado previamente en tu computadora:</p>
                <input type="file" id="fileInput" accept=".json" style="
                    width: 100%;
                    padding: 10px;
                    background: rgba(255,255,255,0.1);
                    border: 2px dashed rgba(255,255,255,0.3);
                    border-radius: 8px;
                    color: white;
                    cursor: pointer;
                    margin-bottom: 15px;
                ">
                <div id="importStatus" style="color: #10b981; font-size: 13px;"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="loadSelectedFile()">Cargar Proyecto</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n guardar -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <div class="modal-title">üíæ Guardar Proyecto</div>
            <div class="modal-text">
                <p style="margin-bottom: 15px;">Dale un nombre a tu proyecto:</p>
                <input type="text" id="projectName" class="property-input" placeholder="Mi_Proyecto_3D" value="Mi_Proyecto_3D" style="margin-bottom: 15px;">
                <div style="background: rgba(16, 185, 129, 0.2); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6;">
                    <strong>üì¶ Tu proyecto incluye:</strong><br>
                    ‚Ä¢ <span id="saveObjectCount">0</span> objetos 3D<br>
                    ‚Ä¢ <span id="saveBlockCount">0</span> bloques de programaci√≥n<br>
                    ‚Ä¢ C√≥digo generado autom√°ticamente<br>
                    <br>
                    El archivo se descargar√° a tu carpeta de Descargas
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSaveModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmSaveProject()">üíæ Descargar Archivo</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales Three.js
        let scene, camera, renderer, raycaster, mouse;
        let objects = [];
        let selectedObject = null;
        let currentTool = 'select';
        let currentColor = '#ef4444';
        let isMouseDown = false;
        let gridHelper;
        
        // Variables de programaci√≥n
        let programBlocks = [];
        let blockCounter = 0;
        let isSimulationRunning = false;
        
        // Inicializar Three.js
        function initThree() {
            const container = document.getElementById('canvas3d');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x16213e);
            
            camera = new THREE.PerspectiveCamera(
                75,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Luces
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Grid
            gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);
            
            // Raycaster para selecci√≥n
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // Event listeners
            renderer.domElement.addEventListener('click', onCanvasClick);
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            window.addEventListener('resize', onWindowResize);
            
            animate();
        }
        
        // Animaci√≥n
        function animate() {
            requestAnimationFrame(animate);
            
            // Auto-rotar objetos en simulaci√≥n
            if (isSimulationRunning) {
                objects.forEach(obj => {
                    if (obj.userData.animate) {
                        obj.rotation.y += 0.02;
                    }
                });
            }
            
            renderer.render(scene, camera);
        }
        
        // Selecci√≥n de herramienta
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
        }
        
        // Selecci√≥n de color
        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Agregar forma
        function addShape(type) {
            let geometry;
            
            switch(type) {
                case 'box':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                    break;
                case 'plane':
                    geometry = new THREE.PlaneGeometry(2, 2);
                    break;
            }
            
            const material = new THREE.MeshPhongMaterial({ 
                color: currentColor,
                flatShading: false
            });
            const mesh = new THREE.Mesh(geometry, material);
            
            mesh.position.set(
                Math.random() * 4 - 2,
                1,
                Math.random() * 4 - 2
            );
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            
            mesh.userData = {
                id: Date.now(),
                type: type,
                name: `${type}_${objects.length + 1}`,
                animate: false
            };
            
            scene.add(mesh);
            objects.push(mesh);
            updateObjectCount();
        }
        
        // Click en canvas
        function onCanvasClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects);
            
            if (intersects.length > 0) {
                const object = intersects[0].object;
                
                switch(currentTool) {
                    case 'select':
                        selectObject(object);
                        break;
                    case 'paint':
                        object.material.color.setStyle(currentColor);
                        break;
                    case 'delete':
                        deleteObject(object);
                        break;
                }
            } else {
                if (currentTool === 'select') {
                    deselectObject();
                }
            }
        }
        
        // Seleccionar objeto
        function selectObject(object) {
            if (selectedObject) {
                selectedObject.material.emissive.setHex(0x000000);
            }
            
            selectedObject = object;
            selectedObject.material.emissive.setHex(0x555555);
            updatePropertiesPanel();
        }
        
        // Deseleccionar objeto
        function deselectObject() {
            if (selectedObject) {
                selectedObject.material.emissive.setHex(0x000000);
                selectedObject = null;
                clearPropertiesPanel();
            }
        }
        
        // Eliminar objeto
        function deleteObject(object) {
            scene.remove(object);
            objects = objects.filter(obj => obj !== object);
            if (selectedObject === object) {
                deselectObject();
            }
            updateObjectCount();
        }
        
        // Actualizar panel de propiedades
        function updatePropertiesPanel() {
            if (!selectedObject) return;
            
            const props = document.getElementById('properties-content');
            props.innerHTML = `
                <div class="property-item">
                    <div class="property-label">Nombre</div>
                    <input type="text" class="property-input" value="${selectedObject.userData.name}" 
                           onchange="selectedObject.userData.name = this.value">
                </div>
                <div class="property-item">
                    <div class="property-label">Posici√≥n X</div>
                    <input type="number" class="property-input" step="0.1" value="${selectedObject.position.x.toFixed(2)}" 
                           onchange="selectedObject.position.x = parseFloat(this.value)">
                </div>
                <div class="property-item">
                    <div class="property-label">Posici√≥n Y</div>
                    <input type="number" class="property-input" step="0.1" value="${selectedObject.position.y.toFixed(2)}" 
                           onchange="selectedObject.position.y = parseFloat(this.value)">
                </div>
                <div class="property-item">
                    <div class="property-label">Posici√≥n Z</div>
                    <input type="number" class="property-input" step="0.1" value="${selectedObject.position.z.toFixed(2)}" 
                           onchange="selectedObject.position.z = parseFloat(this.value)">
                </div>
                <div class="property-item">
                    <div class="property-label">Escala</div>
                    <input type="number" class="property-input" step="0.1" value="${selectedObject.scale.x.toFixed(2)}" 
                           onchange="selectedObject.scale.set(parseFloat(this.value), parseFloat(this.value), parseFloat(this.value))">
                </div>
                <div class="property-item">
                    <div class="property-label">Rotaci√≥n Y</div>
                    <input type="number" class="property-input" step="5" value="${Math.round(selectedObject.rotation.y * 180 / Math.PI)}" 
                           onchange="selectedObject.rotation.y = parseFloat(this.value) * Math.PI / 180">
                </div>
                <div class="property-item">
                    <div class="property-label">Color</div>
                    <input type="color" class="property-input" value="${'#' + selectedObject.material.color.getHexString()}" 
                           onchange="selectedObject.material.color.setStyle(this.value)">
                </div>
            `;
        }
        
        // Limpiar panel de propiedades
        function clearPropertiesPanel() {
            document.getElementById('properties-content').innerHTML = `
                <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                    Selecciona un objeto para ver sus propiedades
                </p>
            `;
        }
        
        // Mouse events para manipulaci√≥n
        let previousMousePosition = { x: 0, y: 0 };
        
        function onMouseDown(event) {
            isMouseDown = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseMove(event) {
            if (!isMouseDown) return;
            
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;
            
            if (selectedObject && currentTool === 'move') {
                selectedObject.position.x += deltaX * 0.01;
                selectedObject.position.y -= deltaY * 0.01;
                updatePropertiesPanel();
            } else if (selectedObject && currentTool === 'rotate') {
                selectedObject.rotation.y += deltaX * 0.01;
                selectedObject.rotation.x += deltaY * 0.01;
                updatePropertiesPanel();
            } else if (selectedObject && currentTool === 'scale') {
                const scale = selectedObject.scale.x + deltaY * 0.01;
                selectedObject.scale.set(scale, scale, scale);
                updatePropertiesPanel();
            } else {
                // Rotar c√°mara
                camera.position.x = camera.position.x * Math.cos(deltaX * 0.01) - camera.position.z * Math.sin(deltaX * 0.01);
                camera.position.z = camera.position.x * Math.sin(deltaX * 0.01) + camera.position.z * Math.cos(deltaX * 0.01);
                camera.lookAt(0, 0, 0);
            }
            
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseUp() {
            isMouseDown = false;
        }
        
        // Resize
        function onWindowResize() {
            const container = document.getElementById('canvas3d');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Reset c√°mara
        function resetCamera() {
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
        }
        
        // Toggle grid
        function toggleGrid() {
            gridHelper.visible = !gridHelper.visible;
        }
        
        // Actualizar contador
        function updateObjectCount() {
            document.getElementById('object-count').textContent = `Objetos: ${objects.length}`;
        }
        
        // Limpiar todo
        function clearAll() {
            if (confirm('¬øEst√°s seguro de eliminar todos los objetos y bloques?')) {
                objects.forEach(obj => scene.remove(obj));
                objects = [];
                programBlocks = [];
                deselectObject();
                updateObjectCount();
                updateWorkspace();
                updateCodePreview();
            }
        }
        
        // SISTEMA DE PROGRAMACI√ìN POR BLOQUES
        
        // Setup drag and drop
        document.addEventListener('DOMContentLoaded', () => {
            initThree();
            setupDragAndDrop();
        });
        
        function setupDragAndDrop() {
            const workspace = document.getElementById('workspace');
            
            // Drag start en bloques de paleta
            document.querySelectorAll('.block-item').forEach(block => {
                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('blockType', block.dataset.block);
                    e.dataTransfer.setData('blockText', block.textContent.trim());
                    e.dataTransfer.setData('blockCategory', block.classList.contains('event') ? 'event' : 
                                                            block.classList.contains('control') ? 'control' :
                                                            block.classList.contains('motion') ? 'motion' : 'looks');
                });
            });
            
            // Drop en workspace
            workspace.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            workspace.addEventListener('drop', (e) => {
                e.preventDefault();
                const blockType = e.dataTransfer.getData('blockType');
                const blockText = e.dataTransfer.getData('blockText');
                const blockCategory = e.dataTransfer.getData('blockCategory');
                
                addBlockToWorkspace(blockType, blockText, blockCategory);
            });
        }
        
        // Agregar bloque al workspace
        function addBlockToWorkspace(type, text, category) {
            const block = {
                id: blockCounter++,
                type: type,
                text: text,
                category: category,
                params: extractParams(text)
            };
            
            programBlocks.push(block);
            updateWorkspace();
            updateCodePreview();
        }
        
        // Extraer par√°metros del texto
        function extractParams(text) {
            const params = [];
            const matches = text.match(/\[([^\]]+)\]/g);
            if (matches) {
                matches.forEach(match => {
                    params.push(match.replace(/[\[\]]/g, ''));
                });
            }
            return params;
        }
        
        // Actualizar workspace visual
        function updateWorkspace() {
            const workspace = document.getElementById('workspace');
            
            if (programBlocks.length === 0) {
                workspace.innerHTML = `
                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px;">
                        Arrastra bloques aqu√≠ para programar
                    </p>
                `;
                return;
            }
            
            workspace.innerHTML = '';
            
            programBlocks.forEach((block, index) => {
                const blockEl = document.createElement('div');
                blockEl.className = `dropped-block ${block.category}`;
                blockEl.innerHTML = `
                    <span>${block.text}</span>
                    <button class="block-delete" onclick="removeBlock(${index})">‚úï</button>
                `;
                workspace.appendChild(blockEl);
            });
        }
        
        // Remover bloque
        function removeBlock(index) {
            programBlocks.splice(index, 1);
            updateWorkspace();
            updateCodePreview();
        }
        
        // Generar c√≥digo JavaScript
        function updateCodePreview() {
            let code = '// C√≥digo generado autom√°ticamente\n\n';
            
            if (programBlocks.length === 0) {
                code = '// El c√≥digo aparecer√° aqu√≠...';
            } else {
                let indent = 0;
                
                programBlocks.forEach(block => {
                    const indentation = '  '.repeat(indent);
                    
                    switch(block.type) {
                        case 'start':
                            code += `${indentation}function onStart() {\n`;
                            indent++;
                            break;
                        case 'click':
                            code += `${indentation}object.onClick = function() {\n`;
                            indent++;
                            break;
                        case 'key':
                            code += `${indentation}document.addEventListener('keydown', (e) => {\n`;
                            indent++;
                            code += `${indentation}  if (e.key === 'space') {\n`;
                            indent++;
                            break;
                        case 'wait':
                            code += `${indentation}await sleep(${block.params[0]} * 1000);\n`;
                            break;
                        case 'repeat':
                            code += `${indentation}for (let i = 0; i < ${block.params[0]}; i++) {\n`;
                            indent++;
                            break;
                        case 'forever':
                            code += `${indentation}while (true) {\n`;
                            indent++;
                            break;
                        case 'if':
                            code += `${indentation}if (condition) {\n`;
                            indent++;
                            break;
                        case 'moveX':
                            code += `${indentation}object.position.x += ${block.params[0]};\n`;
                            break;
                        case 'moveY':
                            code += `${indentation}object.position.y += ${block.params[0]};\n`;
                            break;
                        case 'moveZ':
                            code += `${indentation}object.position.z += ${block.params[0]};\n`;
                            break;
                        case 'rotate':
                            code += `${indentation}object.rotation.y += ${block.params[0]} * Math.PI / 180;\n`;
                            break;
                        case 'goto':
                            code += `${indentation}object.position.set(${block.params[0]}, ${block.params[1]}, ${block.params[2]});\n`;
                            break;
                        case 'color':
                            code += `${indentation}object.material.color.setStyle('${block.params[0]}');\n`;
                            break;
                        case 'size':
                            const scale = parseInt(block.params[0]) / 100;
                            code += `${indentation}object.scale.set(${scale}, ${scale}, ${scale});\n`;
                            break;
                        case 'show':
                            code += `${indentation}object.visible = true;\n`;
                            break;
                        case 'hide':
                            code += `${indentation}object.visible = false;\n`;
                            break;
                    }
                });
                
                // Cerrar bloques abiertos
                while (indent > 0) {
                    indent--;
                    code += '  '.repeat(indent) + '}\n';
                }
            }
            
            document.getElementById('code-preview').textContent = code;
        }
        
        // Ejecutar simulaci√≥n
        function runSimulation() {
            if (objects.length === 0) {
                alert('Agrega objetos 3D primero');
                return;
            }
            
            if (programBlocks.length === 0) {
                alert('Agrega bloques de programaci√≥n');
                return;
            }
            
            document.getElementById('runModal').classList.add('active');
            document.getElementById('runStatus').textContent = 'Ejecutando simulaci√≥n...';
            
            isSimulationRunning = true;
            
            // Ejecutar bloques
            executeBlocks();
            
            setTimeout(() => {
                document.getElementById('runStatus').textContent = '‚úÖ Simulaci√≥n completada';
            }, 2000);
        }
        
        // Ejecutar bloques de programa
        async function executeBlocks() {
            for (const block of programBlocks) {
                if (!isSimulationRunning) break;
                
                if (objects.length > 0) {
                    const obj = objects[0]; // Ejecutar en primer objeto
                    
                    switch(block.type) {
                        case 'wait':
                            await sleep(parseFloat(block.params[0]) * 1000);
                            break;
                        case 'moveX':
                            obj.position.x += parseFloat(block.params[0]);
                            break;
                        case 'moveY':
                            obj.position.y += parseFloat(block.params[0]);
                            break;
                        case 'moveZ':
                            obj.position.z += parseFloat(block.params[0]);
                            break;
                        case 'rotate':
                            obj.rotation.y += parseFloat(block.params[0]) * Math.PI / 180;
                            break;
                        case 'color':
                            const colorMap = {
                                'rojo': '#ef4444',
                                'azul': '#3b82f6',
                                'verde': '#10b981',
                                'amarillo': '#fbbf24'
                            };
                            obj.material.color.setStyle(colorMap[block.params[0]] || '#ffffff');
                            break;
                        case 'size':
                            const scale = parseInt(block.params[0]) / 100;
                            obj.scale.set(scale, scale, scale);
                            break;
                        case 'show':
                            obj.visible = true;
                            break;
                        case 'hide':
                            obj.visible = false;
                            break;
                    }
                    
                    obj.userData.animate = true;
                }
                
                await sleep(100);
            }
        }
        
        // Helper sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Detener simulaci√≥n
        function stopSimulation() {
            isSimulationRunning = false;
            objects.forEach(obj => obj.userData.animate = false);
            closeModal();
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('runModal').classList.remove('active');
        }
        
        // SISTEMA DE GUARDAR E IMPORTAR
        
        // Guardar proyecto
        function saveProject() {
            if (objects.length === 0) {
                alert('‚ö†Ô∏è No hay objetos para guardar. Crea algunos objetos 3D primero.');
                return;
            }
            
            // Actualizar contadores en el modal
            document.getElementById('saveObjectCount').textContent = objects.length;
            document.getElementById('saveBlockCount').textContent = programBlocks.length;
            
            // Mostrar modal de guardar
            document.getElementById('saveModal').classList.add('active');
            
            // Generar nombre con fecha
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
            document.getElementById('projectName').value = `Proyecto_3D_${dateStr}`;
        }
        
        // Confirmar y descargar proyecto
        function confirmSaveProject() {
            const projectName = document.getElementById('projectName').value || 'Proyecto_3D';
            
            const project = {
                version: '1.0',
                name: projectName,
                createdAt: new Date().toISOString(),
                objects: objects.map(obj => ({
                    type: obj.userData.type,
                    name: obj.userData.name,
                    id: obj.userData.id,
                    position: {
                        x: obj.position.x,
                        y: obj.position.y,
                        z: obj.position.z
                    },
                    rotation: {
                        x: obj.rotation.x,
                        y: obj.rotation.y,
                        z: obj.rotation.z
                    },
                    scale: {
                        x: obj.scale.x,
                        y: obj.scale.y,
                        z: obj.scale.z
                    },
                    color: '#' + obj.material.color.getHexString(),
                    visible: obj.visible,
                    animate: obj.userData.animate
                })),
                blocks: programBlocks,
                code: document.getElementById('code-preview').textContent,
                cameraPosition: {
                    x: camera.position.x,
                    y: camera.position.y,
                    z: camera.position.z
                }
            };
            
            // Crear archivo JSON
            const dataStr = JSON.stringify(project, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Descargar archivo
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Cerrar modal y mostrar confirmaci√≥n
            closeSaveModal();
            
            // Mostrar notificaci√≥n
            showNotification('‚úÖ Proyecto guardado correctamente en tu carpeta de Descargas', 'success');
        }
        
        // Cerrar modal de guardar
        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
        }
        
        // Importar proyecto
        function importProject() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importStatus').textContent = '';
            document.getElementById('fileInput').value = '';
        }
        
        // Cargar archivo seleccionado
        function loadSelectedFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('importStatus').innerHTML = '‚ö†Ô∏è Por favor selecciona un archivo';
                document.getElementById('importStatus').style.color = '#f59e0b';
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                document.getElementById('importStatus').innerHTML = '‚ùå El archivo debe ser .json';
                document.getElementById('importStatus').style.color = '#ef4444';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const project = JSON.parse(e.target.result);
                    
                    // Validar estructura del proyecto
                    if (!project.objects || !Array.isArray(project.objects)) {
                        throw new Error('Formato de proyecto inv√°lido');
                    }
                    
                    // Limpiar escena actual
                    objects.forEach(obj => scene.remove(obj));
                    objects = [];
                    programBlocks = [];
                    deselectObject();
                    
                    // Cargar objetos
                    project.objects.forEach(objData => {
                        loadObject(objData);
                    });
                    
                    // Cargar bloques de programaci√≥n
                    if (project.blocks && Array.isArray(project.blocks)) {
                        programBlocks = project.blocks;
                        blockCounter = Math.max(...programBlocks.map(b => b.id), 0) + 1;
                    }
                    
                    // Restaurar posici√≥n de c√°mara
                    if (project.cameraPosition) {
                        camera.position.set(
                            project.cameraPosition.x,
                            project.cameraPosition.y,
                            project.cameraPosition.z
                        );
                        camera.lookAt(0, 0, 0);
                    }
                    
                    // Actualizar UI
                    updateObjectCount();
                    updateWorkspace();
                    updateCodePreview();
                    
                    // Cerrar modal
                    closeImportModal();
                    
                    // Mostrar notificaci√≥n
                    showNotification(`‚úÖ Proyecto "${project.name || 'Sin nombre'}" cargado correctamente`, 'success');
                    
                } catch (error) {
                    console.error('Error al cargar proyecto:', error);
                    document.getElementById('importStatus').innerHTML = '‚ùå Error: Archivo corrupto o formato incorrecto';
                    document.getElementById('importStatus').style.color = '#ef4444';
                }
            };
            
            reader.onerror = function() {
                document.getElementById('importStatus').innerHTML = '‚ùå Error al leer el archivo';
                document.getElementById('importStatus').style.color = '#ef4444';
            };
            
            reader.readAsText(file);
        }
        
        // Cargar un objeto desde datos guardados
        function loadObject(objData) {
            let geometry;
            
            switch(objData.type) {
                case 'box':
                    geometry = new THREE.BoxGeometry(1, 1, 1);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                    break;
                case 'plane':
                    geometry = new THREE.PlaneGeometry(2, 2);
                    break;
                default:
                    geometry = new THREE.BoxGeometry(1, 1, 1);
            }
            
            const material = new THREE.MeshPhongMaterial({ 
                color: objData.color || '#ef4444',
                flatShading: false
            });
            const mesh = new THREE.Mesh(geometry, material);
            
            // Restaurar propiedades
            mesh.position.set(objData.position.x, objData.position.y, objData.position.z);
            mesh.rotation.set(objData.rotation.x, objData.rotation.y, objData.rotation.z);
            mesh.scale.set(objData.scale.x, objData.scale.y, objData.scale.z);
            mesh.visible = objData.visible !== undefined ? objData.visible : true;
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            
            mesh.userData = {
                id: objData.id || Date.now(),
                type: objData.type,
                name: objData.name || `${objData.type}_${objects.length + 1}`,
                animate: objData.animate || false
            };
            
            scene.add(mesh);
            objects.push(mesh);
        }
        
        // Cerrar modal de importar
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }
        
        // Mostrar notificaci√≥n temporal
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                             type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 
                             'linear-gradient(135deg, #3b82f6, #2563eb)'};
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 3000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // Agregar animaci√≥n
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Exportar proyecto (funci√≥n legacy, ahora usa saveProject)
        function exportProject() {
            saveProject();
        }
    </script>
</body>
</html>
